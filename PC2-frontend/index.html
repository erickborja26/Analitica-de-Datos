<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PC2 API Explorer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="hero-copy">
        <h1>PC2 API Explorer</h1>
        <p>Tablero visual para probar los endpoints del backend en <code>PC2/app.py</code>.</p>
      </div>
      <form id="config-form" class="config-form">
        <label>
          Base URL de la API (app.py)
          <input type="url" id="base-url" value="http://localhost:5000" required />
        </label>
        <label>
          API Key
          <input type="text" id="api-key" placeholder="Opcional" />
        </label>
        <button type="submit">Actualizar</button>
      </form>
      <div class="quick-actions" aria-label="Acciones rápidas">
        <button class="quick-card" data-action="health">
          <span class="quick-title">Ping</span>
          <span class="quick-subtitle">/v1/health</span>
        </button>
        <button class="quick-card" data-action="stations">
          <span class="quick-title">Estaciones</span>
          <span class="quick-subtitle">Listar estaciones</span>
        </button>
        <button class="quick-card" data-action="measurements-latest">
          <span class="quick-title">Últimos datos</span>
          <span class="quick-subtitle">Por estación</span>
        </button>
        <button class="quick-card" data-action="alert-rules">
          <span class="quick-title">Alertas</span>
          <span class="quick-subtitle">Reglas activas</span>
        </button>
      </div>
      <div class="latest-alert" id="latest-alert" aria-live="polite">
        <div class="latest-alert__icon" aria-hidden="true">
          <span class="latest-alert__pulse"></span>
          <span class="latest-alert__symbol">!</span>
        </div>
        <div class="latest-alert__content">
          <p class="latest-alert__label">Último evento de alerta</p>
          <p class="latest-alert__message" id="latest-alert-message">Aún no hay eventos de alerta registrados.</p>
          <p class="latest-alert__time" id="latest-alert-time" hidden>—</p>
          <dl class="latest-alert__details" id="latest-alert-details" hidden></dl>
        </div>
        <button type="button" class="latest-alert__refresh" id="latest-alert-refresh">Actualizar</button>
      </div>
      <div id="status" class="status" aria-live="polite"></div>
    </header>

    <main class="workspace">
      <div class="workspace-main">
        <section>
          <h2>Salud del servicio</h2>
          <button data-action="health">Consultar /v1/health</button>
          <pre class="result" id="health-result"></pre>
          <div class="example-panel" id="health-example" aria-live="polite">
            <p class="example-placeholder">Aquí verás una tarjeta resumen con el estado del servicio.</p>
          </div>
        </section>

        <section>
      <h2>Estaciones</h2>
      <button data-action="stations">Listar /v1/stations</button>
      <div class="form-row">
        <input type="number" min="1" id="station-id" placeholder="ID de estación" />
        <button data-action="station-detail">Ver detalle</button>
        <button data-action="station-latest">Última medición</button>
      </div>
      <div class="form-row">
        <input type="number" min="1" id="station-limit" placeholder="Límite (def. 100)" />
        <input type="number" min="0" id="station-offset" placeholder="Offset" />
        <select id="station-order">
          <option value="desc" selected>Ordenar por fecha ↓</option>
          <option value="asc">Ordenar por fecha ↑</option>
        </select>
        <button data-action="station-measurements">Historial mediciones</button>
      </div>
      <div class="form-row">
        <input type="datetime-local" id="station-start" placeholder="Inicio (opcional)" />
        <input type="datetime-local" id="station-end" placeholder="Fin (opcional)" />
        <input type="text" id="station-fields" placeholder="fields=pm25,pm10" />
        <input type="text" id="station-tz" placeholder="tz=America/Lima" />
      </div>
      <pre class="result" id="stations-result"></pre>
      <div class="example-panel" id="stations-example" aria-live="polite">
        <p class="example-placeholder">Cuando consultes estaciones verás tarjetas con su ubicación y coordenadas.</p>
      </div>
    </section>

    <section>
      <h2>Mediciones globales</h2>
      <button data-action="measurements">Listar /v1/measurements</button>
      <button data-action="measurements-latest">Últimas por estación</button>
      <div class="form-row">
        <input type="text" id="measurement-fields" placeholder="fields=pm25,pm10" />
        <input type="number" min="1" id="measurement-limit" placeholder="Límite" />
        <input type="number" min="0" id="measurement-offset" placeholder="Offset" />
        <select id="measurement-order">
          <option value="asc">Ordenar por fecha ↑</option>
          <option value="desc">Ordenar por fecha ↓</option>
        </select>
        <button data-action="measurements-custom">Aplicar filtros</button>
      </div>
      <div class="form-row">
        <input type="datetime-local" id="measurement-start" placeholder="Inicio (ISO)" />
        <input type="datetime-local" id="measurement-end" placeholder="Fin (ISO)" />
        <input type="text" id="measurement-tz" placeholder="tz=America/Lima" />
        <button data-action="measurements-range">Filtrar por rango</button>
      </div>
      <div class="form-row">
        <input type="text" id="measurement-station-ids" placeholder="IDs de estación (ej. 1,2,3)" />
        <button data-action="measurements-by-ids">Multi-estación por ID</button>
      </div>
      <div class="form-row">
        <input type="text" id="measurement-station-names" placeholder="Nombres de estación (coma)" />
        <button data-action="measurements-by-names">Multi-estación por nombre</button>
      </div>
      <pre class="result" id="measurements-result"></pre>
      <div class="example-panel" id="measurements-example" aria-live="polite">
        <p class="example-placeholder">Las mediciones recientes aparecerán en una mini línea de tiempo.</p>
      </div>
    </section>

    <section>
      <h2>Mapa de calor horario (todas las estaciones)</h2>
      <p class="section-hint">Calcula el promedio por hora del día de cada contaminante promediando todas las estaciones seleccionadas.</p>
      <div class="form-row heatmap-controls">
        <input type="datetime-local" id="heatmap-start" placeholder="Inicio (opcional)" />
        <input type="datetime-local" id="heatmap-end" placeholder="Fin (opcional)" />
        <input type="text" id="heatmap-tz" placeholder="Zona horaria (America/Lima)" />
        <button data-action="heatmap-load">Generar mapa</button>
      </div>
      <p id="heatmap-message" class="heatmap-message">Consulta el rango deseado y haz clic en «Generar mapa».</p>
      <div id="heatmap-container" class="heatmap-wrapper" aria-live="polite" aria-busy="false">
        <p class="heatmap-placeholder">Aún no hay datos para mostrar.</p>
      </div>
    </section>

    <section>
      <h2>Agregados</h2>
      <form id="aggregates-form" class="form-grid">
        <label>
          Tipo
          <select id="aggregate-type">
            <option value="hourly">/v1/aggregates/hourly</option>
            <option value="daily">/v1/aggregates/daily</option>
          </select>
        </label>
        <label>
          station_id
          <input type="number" min="1" id="aggregate-station" />
        </label>
        <label>
          start (ISO)
          <input type="datetime-local" id="aggregate-start" />
        </label>
        <label>
          end (ISO)
          <input type="datetime-local" id="aggregate-end" />
        </label>
        <label>
          tz
          <input type="text" id="aggregate-tz" placeholder="America/Lima" />
        </label>
        <label>
          fields
          <input type="text" id="aggregate-fields" placeholder="pm25,pm10" />
        </label>
        <label>
          limit
          <input type="number" min="1" id="aggregate-limit" />
        </label>
        <label>
          offset
          <input type="number" min="0" id="aggregate-offset" />
        </label>
        <button type="submit">Consultar agregados</button>
      </form>
      <pre class="result" id="aggregates-result"></pre>
      <div class="example-panel" id="aggregates-example" aria-live="polite">
        <p class="example-placeholder">Los agregados se mostrarán como tabla con promedios y extremos.</p>
      </div>
    </section>

    <section>
      <h2>Alertas &amp; reglas</h2>
      <div class="form-row">
        <button data-action="alert-rules">Listar reglas</button>
        <button data-action="alert-events">Ver eventos</button>
      </div>
      <details>
        <summary>Crear nueva regla</summary>
        <form id="create-rule-form" class="form-grid">
          <label>Nombre<input required type="text" id="rule-name" /></label>
          <label>station_id<input type="number" min="1" id="rule-station" /></label>
          <label>Pollutant<select id="rule-pollutant" required>
            <option value="pm25">pm25</option>
            <option value="pm10">pm10</option>
            <option value="so2">so2</option>
            <option value="no2">no2</option>
            <option value="o3">o3</option>
            <option value="co">co</option>
          </select></label>
          <label>Operator<select id="rule-operator" required>
            <option value="gt">&gt;</option>
            <option value="ge">≥</option>
            <option value="lt">&lt;</option>
            <option value="le">≤</option>
          </select></label>
          <label>Threshold<input type="number" step="any" id="rule-threshold" required /></label>
          <label>Window<input type="text" id="rule-window" placeholder="Opcional" /></label>
          <label>Enabled<select id="rule-enabled"><option value="true">Sí</option><option value="false">No</option></select></label>
          <label><input type="checkbox" id="rule-evaluate" /> Evaluar inmediatamente</label>
          <button type="submit">Crear regla</button>
        </form>
      </details>
      <details>
        <summary>Evaluar reglas manualmente</summary>
        <form id="evaluate-rules-form" class="form-row">
          <input type="number" min="1" id="evaluate-rule-id" placeholder="rule_id (opcional)" />
          <button type="submit">Ejecutar POST /v1/alerts/evaluate</button>
        </form>
        <p class="section-hint">Ejecuta la evaluación de alertas forzando el cálculo inmediato. Si proporcionas <code>rule_id</code>,
          solo se evaluará esa regla.</p>
      </details>
      <details>
        <summary>Actualizar / eliminar regla</summary>
        <form id="update-rule-form" class="form-grid">
          <label>ID regla<input type="number" min="1" id="update-rule-id" required /></label>
          <label>Payload JSON
            <textarea id="update-payload" rows="4" placeholder='{"threshold":45,"enabled":false}'></textarea>
          </label>
          <button type="submit">Actualizar</button>
        </form>
        <form id="delete-rule-form" class="form-row">
          <input type="number" min="1" id="delete-rule-id" placeholder="ID a eliminar" required />
          <button type="submit" class="danger">Eliminar</button>
        </form>
      </details>
      <pre class="result" id="alerts-result"></pre>
      <div class="example-panel" id="alerts-example" aria-live="polite">
        <p class="example-placeholder">Aquí verás una lista rápida de reglas activas o eventos recientes.</p>
      </div>
    </section>

    <section>
      <h2>Exportar CSV</h2>
      <p>Descarga directa del endpoint <code>/v1/export/csv</code>.</p>
      <div class="form-row">
        <input type="text" id="export-query" placeholder="Query string opcional (p.ej. station_id=1)" />
        <button data-action="export-csv">Descargar</button>
      </div>
          <div id="export-status"></div>
        </section>
      </div>
      <aside class="workspace-aside">
        <section class="sidebar-card">
          <h2>Ayuda rápida</h2>
          <ul>
            <li>Los parámetros se envían como query strings (GET) o JSON (POST/PUT).</li>
            <li>Los resultados se muestran en formato JSON con sangría.</li>
            <li>Si configuraste <code>API_KEY</code> en el backend, ingrésala arriba para incluirla automáticamente.</li>
            <li>Cada resultado puede copiarse haciendo clic en el panel.</li>
          </ul>
        </section>
        <section class="sidebar-card history-card">
          <div class="history-header">
            <h2>Historial de solicitudes</h2>
            <button id="clear-history" type="button" class="ghost">Limpiar</button>
          </div>
          <p class="history-hint">Haz clic en un elemento para volver a ver la respuesta o copiar el cURL.</p>
          <ul id="request-history" class="history-list" aria-live="polite"></ul>
          <pre class="result compact" id="history-preview">Aquí aparecerán las respuestas del historial.</pre>
        </section>
      </aside>
    </main>

    <footer class="app-footer">
      <span>Explorador interactivo para la API de monitoreo ambiental.</span>
      <span class="badge">PC2</span>
    </footer>
  </div>

  <template id="loading-template">Cargando…</template>
  <script src="app.js"></script>
</body>
</html>
